function testPlateBentIntoACircleKirchoffLoveShellAnalysis(testCase)
%% Licensing
%
% License:         BSD License
%                  cane Multiphysics default license: cane/license.txt
%
% Main authors:    Andreas Apostolatos
%
%% Function definition
%
% Test the geometrically nonlinear Kirchoff-Love shell isogeometric 
% analysis over the single patch plate bent into a circle problem.
%
% Function layout :
%
% 0. Read input
%
% 1. Define the NURBS block
%
% 2. Define material constants
%
% 3. GUI
%
% 4. Define refinement
%
% 5. Define Dirichlet and Neumann boundary conditions
%
% 6. Create the B-Spline patch array
%
% 7. Define the expected solution
%
% 8. Define nonlinear analysis parameters
%
% 9. Solve the nonlinear system
%
% 10. Verify the results
%
%% Function main body

%% 0. Read input

% Define a tolerance for the verification of the results
relaxationFactor = 1e2;
absTol = relaxationFactor*1e-15;
relaxationFactorForces = relaxationFactor*1e2;
absTolRelaxed5 = relaxationFactorForces*absTol*1e5;

%% 1. Define the NURBS block

% Global variables:
Length = 12;
Width = 1;

% Polynomial degrees
p = 1;
q = 1;

% Knot vectors
Xi = [0 0 1 1];
Eta = [0 0 1 1];

% Control Point coordinates

% x-coordinates
CP(:,:,1) = [0  0
             1  1]*Length;
         
% y-coordinates
CP(:,:,2) = [-Width/2 Width/2
             -Width/2 Width/2];
         
% z-coordinates
CP(:,:,3) = [0 0
             0 0];
       
% Weights
CP(:,:,4) = [1 1
             1 1];
       
% Find whether the geometrical basis is a NURBS or a B-Spline
isNURBS = 0;
nxi = length(CP(:,1,1));
neta = length(CP(1,:,1));
for i= 1:nxi
    for j=1:neta
        if CP(i,j,4)~=1
            isNURBS = 1;
            break;
        end
    end
    if isNURBS
        break;
    end
end

%% 2. Define material constants

% Young's modulus
parameters.E = 1.2e6;
% parameters.E = 1e2;

% Poisson ratio
parameters.nue = 0.0;

% Thickness of the shell
parameters.t = .1;

% Density of the shell (used only for dynamics)
parameters.rho = 7810;

%% 3. GUI

% Analysis type
analysis.type = 'isogeometricKirchhoffLoveShellAnalysis';

% Integration scheme
% type = 'default' : default FGI integration element-wise
% type = 'user' : manual choice of the number of Gauss points
int.type = 'user';
if strcmp(int.type,'user')
    int.xiNGP = p + 4;
    int.etaNGP = q + 1;
    int.etaNGPForLoad = ceil((q + 1)/2);
end

% Define linear equation system solver
solve_LinearSystem = @solve_LinearSystemMatlabBackslashSolver;

%% 4. Define refinement

% Degree by which to elevate
tp = 3;
tq = 0;
[Xi,Eta,CP,p,q] = degreeElevateBSplineSurface(p,q,Xi,Eta,CP,tp,tq,'');

% Number of knots to exist in both directions
scaling = 1;
refXi = 12*scaling;
refEta = 0*scaling;
[Xi,Eta,CP] = knotRefineUniformlyBSplineSurface(p,Xi,q,Eta,CP,refXi,refEta,'');

%% 5. Define Dirichlet and Neumann boundary conditions

% supports (Dirichlet boundary conditions)

% Homogeneous Dirichlet boundary conditions
homDOFs = [];
xiSup = [0 0]; etaSup = [0 1];
homDOFs = findDOFsClampedSupportIGAKLShell...
    (homDOFs,xiSup,etaSup,p,Xi,q,Eta,CP,isNURBS);
xiSup = [0 1]; etaSup = [0 1];  dir = 2;
homDOFs = findDofs3D(homDOFs,xiSup,etaSup,dir,CP);

% xiSup = [0 1];   etaSup = [0 1];    dirSupp = 2;
% homDOFs = findDofs3D(homDOFs,xiSup,etaSup,dirSupp,CP);

% Inhomogeneous Dirichlet boundary conditions
inhomDOFs = [];
valuesInhomDOFs = [];

% Weak Dirichlet boundary conditions
weakDBC = [];

% Embedded cables
cables = [];

% load (Neuman boundary conditions)
M0 = 25/3;
bendMomentAmp = - 2*pi()*M0;
xib = 1;   etab = [0 1];   dirBendMoment = 'bending';
NBC.noCnd = 1;
NBC.xiLoadExtension = {xib};
NBC.etaLoadExtension = {etab};
NBC.loadAmplitude = {bendMomentAmp};
NBC.loadDirection = {dirBendMoment};
NBC.computeLoadVct{1} = 'computeLoadVctLineMomentIGAKirchhoffLoveShell';
NBC.isFollower(1,1) = true;
NBC.isTimeDependent(1,1) = false;

%% 6. Create the B-Spline patch array
BSplinePatch = fillUpPatch ...
    (analysis,p,Xi,q,Eta,CP,isNURBS,parameters,homDOFs,inhomDOFs,...
    valuesInhomDOFs,weakDBC,cables,NBC,[],[],[],[],[],int);

%% 7. Define the expected solution

% Define the expected solution in terms of Control Point displacements
expSolDHat = [                 0
                               0
                               0
              -0.000077674903397
                               0
                               0
               0.000026635146225
                               0
               0.087174013063593
              -0.070602527732661
                               0
               0.480265204348716
              -0.547607367664281
                               0
               1.386782829003399
              -1.548083109149892
                               0
               2.433484211367721
              -3.072172426718130
                               0
               3.339492694128391
              -4.979124696726146
                               0
               3.861901147175305
              -7.025778928848188
                               0
               3.860678262485632
              -8.931507986360671
                               0
               3.336151917803953
             -10.453478760541236
                               0
               2.428921244532398
             -11.451508624509222
                               0
               1.382221608181389
             -11.926396590064085
                               0
               0.476928565821355
             -11.996109053133168
                               0
               0.085425965455693
             -11.995802404861319
                               0
              -0.000579192405644
             -11.995880762101814
                               0
               0.000004812814751
                               0
                               0
                               0
              -0.000077674903397
                               0
                               0
               0.000026635146225
                               0
               0.087174013063593
              -0.070602527732661
                               0
               0.480265204348717
              -0.547607367664282
                               0
               1.386782829003399
              -1.548083109149892
                               0
               2.433484211367720
              -3.072172426718131
                               0
               3.339492694128391
              -4.979124696726145
                               0
               3.861901147175306
              -7.025778928848188
                               0
               3.860678262485632
              -8.931507986360669
                               0
               3.336151917803952
             -10.453478760541236
                               0
               2.428921244532398
             -11.451508624509218
                               0
               1.382221608181389
             -11.926396590064087
                               0
               0.476928565821355
             -11.996109053133168
                               0
               0.085425965455692
             -11.995802404861321
                               0
              -0.000579192405645
             -11.995880762101814
                               0
               0.000004812814751];
           
% Define the expected solution in terms of the Control Point deformation
expSolCPHist = struc([]);
for counterComp = 1:4
    expSolCPHist{1}(:,:,counterComp,1) = CP(:,:,counterComp);
end
expSolCPHist{1}(:,:,1,2) = [                   0                   0
                               0.249996394345777   0.249996394345777
                               0.749989817627924   0.749989817627924
                               1.495688903303328   1.495688903303328
                               2.464362401549909   2.464362401549908
                               3.390866861187557   3.390866861187558
                               4.259349660456813   4.259349660456815
                               5.054949576617957   5.054949576617955
                               5.764052960558099   5.764052960558098
                               6.374526226250878   6.374526226250874
                               6.875923153084759   6.875923153084760
                               7.259665164934086   7.259665164934084
                               7.519183406844490   7.519183406844491
                               7.617327402362213   7.617327402362214
                               7.639121494381591   7.639121494381591
                               7.639110286186303   7.639110286186303];
expSolCPHist{1}(:,:,2,2) = [  -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000];
expSolCPHist{1}(:,:,3,2) = [                   0                   0
                                               0                   0
                               0.021816508460329   0.021816508460330
                               0.119993936322798   0.119993936322798
                               0.379555607447380   0.379555607447382
                               0.763339158053164   0.763339158053164
                               1.264775022451837   1.264775022451836
                               1.875283958229546   1.875283958229547
                               2.584419134417714   2.584419134417714
                               3.380046420987528   3.380046420987532
                               4.248551700472545   4.248551700472545
                               5.175073365511124   5.175073365511126
                               6.143758499823607   6.143758499823605
                               6.889461986380183   6.889461986380184
                               7.389456387268688   7.389456387268686
                               7.639452781363211   7.639452781363211];
expSolCPHist{1}(:,:,4,2) = [     1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1];
expSolCPHist{1}(:,:,1,3) = [                   0                   0
                               0.249984861448226   0.249984861448226
                               0.749967123079904   0.749967123079904
                               1.482679669644532   1.482679669644532
                               2.358592008348636   2.358592008348635
                               3.073724576240589   3.073724576240590
                               3.579337346509248   3.579337346509248
                               3.840974972395548   3.840974972395549
                               3.840795333903773   3.840795333903774
                               3.578810676181098   3.578810676181094
                               3.072886773292852   3.072886773292852
                               2.357500179931815   2.357500179931812
                               1.481408245493647   1.481408245493649
                               0.748625987131701   0.748625987131701
                               0.248628259982064   0.248628259982066
                              -0.001356585695053  -0.001356585695053];
expSolCPHist{1}(:,:,2,3) = [  -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000];
expSolCPHist{1}(:,:,3,3) = [                   0                   0
                                               0                   0
                               0.043627491766583   0.043627491766584
                               0.240011024266446   0.240011024266445
                               0.745766424545339   0.745766424545340
                               1.461028655873614   1.461028655873613
                               2.337022336355834   2.337022336355834
                               3.314036544501071   3.314036544501070
                               4.325476921554701   4.325476921554701
                               5.302398130923716   5.302398130923716
                               6.178212155811338   6.178212155811338
                               6.893220317487647   6.893220317487645
                               7.398664550235183   7.398664550235185
                               7.594787801177788   7.594787801177789
                               7.638237689893225   7.638237689893225
                               7.638148891970815   7.638148891970815];
expSolCPHist{1}(:,:,4,3) = [     1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1];
expSolCPHist{1}(:,:,1,4) = [                   0                   0
                               0.249962366654694   0.249962366654694
                               0.749960536530127   0.749960536530127
                               1.460729674869212   1.460729674869212
                               2.186082981035186   2.186082981035185
                               2.578452782612758   2.578452782612759
                               2.578036693662871   2.578036693662870
                               2.184974376491288   2.184974376491288
                               1.459101311771627   1.459101311771627
                               0.510986206877804   0.510986206877803
                              -0.514961676902862  -0.514961676902862
                              -1.462482798498073  -1.462482798498073
                              -2.187190948970070  -2.187190948970070
                              -2.481047198186618  -2.481047198186619
                              -2.545892394244660  -2.545892394244660
                              -2.545606246634016  -2.545606246634016];
expSolCPHist{1}(:,:,2,4) = [  -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000];
expSolCPHist{1}(:,:,3,4) = [                   0                   0
                                               0                   0
                               0.065417618211206   0.065417618211207
                               0.360087722553442   0.360087722553442
                               1.085626705886707   1.085626705886708
                               2.033597618971402   2.033597618971401
                               3.059545698672288   3.059545698672289
                               4.007211461409647   4.007211461409646
                               4.732254048748535   4.732254048748536
                               5.124231255888240   5.124231255888239
                               5.123472877402410   5.123472877402412
                               4.730018131115574   4.730018131115570
                               4.003834730216335   4.003834730216337
                               3.292728730238356   3.292728730238357
                               2.792656000328526   2.792656000328527
                               2.542693797459491   2.542693797459491];
expSolCPHist{1}(:,:,4,4) = [     1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1];
expSolCPHist{1}(:,:,1,5) = [                   0                   0
                               0.249922325096603   0.249922325096603
                               0.750026635146225   0.750026635146225
                               1.429397472267339   1.429397472267339
                               1.952392632335719   1.952392632335718
                               1.951916890850107   1.951916890850108
                               1.427827573281870   1.427827573281869
                               0.520875303273854   0.520875303273855
                              -0.525778928848188  -0.525778928848188
                              -1.431507986360670  -1.431507986360669
                              -1.953478760541234  -1.953478760541234
                              -1.951508624509222  -1.951508624509218
                              -1.426396590064085  -1.426396590064087
                              -0.746109053133168  -0.746109053133168
                              -0.245802404861319  -0.245802404861321
                               0.004119237898186   0.004119237898186];
expSolCPHist{1}(:,:,2,5) = [  -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000
                              -0.500000000000000   0.500000000000000];
expSolCPHist{1}(:,:,3,5) = [                   0                   0
                                               0                   0
                               0.087174013063593   0.087174013063593
                               0.480265204348716   0.480265204348717
                               1.386782829003399   1.386782829003399
                               2.433484211367721   2.433484211367720
                               3.339492694128391   3.339492694128391
                               3.861901147175305   3.861901147175306
                               3.860678262485632   3.860678262485632
                               3.336151917803953   3.336151917803952
                               2.428921244532398   2.428921244532398
                               1.382221608181389   1.382221608181389
                               0.476928565821355   0.476928565821355
                               0.085425965455693   0.085425965455692
                              -0.000579192405644  -0.000579192405645
                               0.000004812814751   0.000004812814751];
expSolCPHist{1}(:,:,4,5) = [     1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1
                                 1     1];
                             
% Define the expected solution in terms of the residual history
expSolResHistory = 1e5*[   0.000523598775598   0.000523606327372   0.000523630483628   0.000523677606561
                           1.964772619663940   2.009564810731232   2.113172353594353   2.277500957971698
                           0.520823970426417   0.531495892861586   0.557043196246000   0.598549181608955
                           0.112488932912434   0.114403834448533   0.119368367445990   0.127855809506095
                           0.012848969680845   0.013051658868475   0.013652129078934   0.014756099321757
                           0.000775441436698   0.000817358812137   0.000884194388303   0.000967006699125
                           0.008827808069777   0.008681271196504   0.008220163742688   0.007452335053600
                           0.000325797355354   0.000372559092305   0.000475807101233   0.000650081328678
                           0.005724540684350   0.006056143906253   0.006656384554932   0.007517884957096
                           0.000096818895026   0.000109563787159   0.000133789921229   0.000162706886356
                           0.003583440882279   0.003436491885772   0.003040376221594   0.002571029127983
                           0.000025445872440   0.000026132728352   0.000030145547185   0.000037994730104
                           0.004281714333053   0.005072713433925   0.006265510299565   0.007471407277667
                           0.000029617277417   0.000038124223640   0.000052469170934   0.000067762009482
                           0.000744608343674   0.000662944917919   0.000612763540445   0.000673789154843
                           0.000002751520346   0.000004119499664   0.000007417865984   0.000012093694170
                           0.001330399336704   0.001560033604142   0.001800059609042   0.001998552091693
                           0.000002969432761   0.000003845618162   0.000004734846241   0.000005450298932
                           0.000010498018147   0.000017174834764   0.000041165763665   0.000086867442441
                           0.000000235672291   0.000000478158516   0.000000582009302   0.000000360468112
                           0.000000111240161   0.000000396400203   0.000001574532630   0.000003850114409
                           0.000000000420896   0.000000001080232   0.000000036998738   0.000000213490642
                           0.000000000204493   0.000000003172380   0.000000030018890   0.000000135732561
                           0.000000000000249   0.000000000055783   0.000000001906775   0.000000017992258
                           0.000000000000391   0.000000000027199   0.000000000672006   0.000000006403596
                           0.000000000000002   0.000000000000906   0.000000000064304   0.000000001148068
                                           0   0.000000000000240   0.000000000015914   0.000000000325275
                                           0   0.000000000000012   0.000000000001905   0.000000000067114
                                           0                   0   0.000000000000392   0.000000000017172
                                           0                   0   0.000000000000053   0.000000000003788
                                           0                   0                   0   0.000000000000924
                                           0                   0                   0   0.000000000000212
                                           0                   0                   0   0.000000000000048
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0
                                           0                   0                   0                   0];

%% 8. Define nonlinear analysis parameters
propNLinearAnalysis.method = 'newtonRapshon';
propNLinearAnalysis.noLoadSteps = 4;
propNLinearAnalysis.eps = 10e-9;
propNLinearAnalysis.maxIter = 120;

%% 9. Solve the nonlinear system
graph = [];
plot_IGANonlinear = 'undefined';
% plot_IGANonlinear = @plot_postprocIGAKirchhoffLoveShellMultipatchesNLinear;
[dHatNLinear,CPHistory,resHistory,hasConverged,~] = solve_IGAKirchhoffLoveShellNLinear...
    (BSplinePatch,propNLinearAnalysis,solve_LinearSystem,plot_IGANonlinear,graph,'');

%% 10. Verify the results
testCase.verifyEqual(dHatNLinear,expSolDHat,'AbsTol',absTol);
testCase.verifyEqual(CPHistory,expSolCPHist,'AbsTol',absTol);
testCase.verifyEqual(resHistory,expSolResHistory,'AbsTol',absTolRelaxed5);
testCase.verifyEqual(hasConverged,true);

end
