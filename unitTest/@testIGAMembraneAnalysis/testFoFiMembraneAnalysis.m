function testFoFiMembraneAnalysis(testCase)
%% Licensing
%
% License:         BSD License
%                  cane Multiphysics default license: cane/license.txt
%
% Main authors:    Andreas Apostolatos
%
%% Function documentation
%
% Tests the form-finding algorithm for the case of a membrane four-point 
% sail modelled with a single patch against the Carat++ solution
% 
% Function layout :
%
% 0. Read input
%
% 1. Define the geometry via NURBS
%
% 2. Define the material parameters for the membrane and the cables
%
% 3. Define GUI parameters
%
% 4. Define the h- and the p-refinement
%
% 5. Define the homogeneous Dirichet boundary conditions
%
% 6. Define the inhomogeneous Dirichet boundary conditions
%
% 7. Define the Neumann boundary conditions
%
% 8. Define the weak Dirichlet boundary conditions
%
% 9. Define the cables
%
% 10. Create the B-Spline patch array
%
% 11. Define the expected solution
%
% 12. Solve the form-finding analysis problem
%
% 13. Verify the solution
%
%% Function main body

%% 0. Read input

% Define the tolerances
absTol = 1e-14;
absTolCarat = 1e-10;

%% 1. Define the geometry via NURBS

% Global variables:
Length = 20;
Width = 20;
Height = 10;

% Polynomial degrees
p = 1;
q = 1;

% Knot vectors
Xi = [0 0 1 1];
Eta = [0 0 1 1];

% Control Point coordinates

% x-coordinates
CP(:, :, 1) = [-Length/2 -Length/2
               Length/2  Length/2];
         
% y-coordinates
CP(:, :, 2) = [-Width/2 Width/2
               -Width/2 Width/2];
         
% z-coordinates
CP(:, :, 3) = [Height 0      
               0      Height];
       
% Weights
CP(:, :, 4) = [1 1
               1 1];

% Find whether the geometrical basis is a NURBS or a B-Spline
isNURBS = 0;
nxi = length(CP(:, 1, 1));
neta = length(CP(1, :, 1));
for i = 1:nxi
    for j = 1:neta
        if CP(i, j, 4) ~= 1
            isNURBS = 1;
            break;
        end
    end
    if isNURBS
        break;
    end
end

%% 2. Define the material parameters for the membrane and the cables

% Young's modulus
parameters.E = 600.0e+00;

% Poisson ratio
parameters.nue = 4.00000e-01;

% Thickness
parameters.t = 1.000e-03;

% Density (used only for dynamics)
parameters.rho = 1.300e-03;

% Prestress for the membrane
sigma0 = 3.0e+00;
parameters.prestress.voigtVector = [sigma0
                                    sigma0
                                    0];

% Cable parameters
parametersCable.E = 2.05000e+05;
parametersCable.areaCS = 1.13100e-04;
parametersCable.rho = 8.050e-03;
parametersCable.prestress = 5.3052e+02;
cables.parameters = {parametersCable parametersCable parametersCable parametersCable};

%% 3. Define GUI parameters

% Analysis type
analysis.type = 'isogeometricMembraneAnalysis';

% Define linear equation system solver
solve_LinearSystem = @solve_LinearSystemMatlabBackslashSolver;

% Tolerance for the form-finding algorithm and number of form-finding steps
propFormFinding.tolerance = 1e-18;
propFormFinding.maxNoIter = 10;

% Integration scheme
% type = 'default' : default FGI integration element-wise
% type = 'manual' : manual choice of the number of Gauss points
int.type = 'default';
if strcmp(int.type,'user')
    int.xiNGP = 6;
    int.etaNGP = 6;
    int.xiNGPForLoad = 6;
    int.xetaNGPForLoad = 6;
end

%% 4. Define the h- and the p-refinement

% Degree by which to elevate
a = 1;
tp = a;
tq = a;
[Xi,Eta,CP,p,q] = degreeElevateBSplineSurface(p,q,Xi,Eta,CP,tp,tq,'');

% Number of knots to exist in both directions
scaling = 6;
refXi = ceil((Length/Width)*scaling);
refEta = scaling;
[Xi,Eta,CP] = knotRefineUniformlyBSplineSurface(p,Xi,q,Eta,CP,refXi,refEta,'');

%% 5. Define the homogeneous Dirichet boundary conditions
homDOFs = [];
xiSup = [0 0];   etaSup = [0 0];
for dirSupp = 1:3
    homDOFs = findDofs3D(homDOFs,xiSup,etaSup,dirSupp,CP);
end
xiSup = [0 0];   etaSup = [1 1];
for dirSupp = 1:3
    homDOFs = findDofs3D(homDOFs,xiSup,etaSup,dirSupp,CP);
end
xiSup = [1 1];   etaSup = [0 0];
for dirSupp = 1:3
    homDOFs = findDofs3D(homDOFs,xiSup,etaSup,dirSupp,CP);
end
xiSup = [1 1];   etaSup = [1 1];
for dirSupp = 1:3
    homDOFs = findDofs3D(homDOFs,xiSup,etaSup,dirSupp,CP);
end

%% 6. Define the inhomogeneous Dirichet boundary conditions
inhomDOFs = [];
valuesInhomDOFs = [];

%% 7. Define the Neumann boundary conditions
NBC.noCnd = 0;

%% 8. Define the weak Dirichlet boundary conditions
weakDBC.noCnd = 0;

%% 9. Define the cables
cables.No = 4;
cables.xiExtension = {[0 0] [0 1] [0 1] [1 1]};
cables.etaExtension = {[0 1] [0 0] [1 1] [0 1]};
cables.int.type = 'default'; % 'user'
cables.int.noGPs = 16;

%% 10. Create the B-Spline patch array
BSplinePatch = fillUpPatch...
    (analysis,p,Xi,q,Eta,CP,isNURBS,parameters,homDOFs,inhomDOFs,valuesInhomDOFs,...
    weakDBC,cables,NBC,[],[],[],[],[],int);

%% 11. Define the expected solution

% Define the expected solution in terms of the Control Point coordinates
% for each form-finding iteration step
expSoCPHistory = struct([]);
% Form-finding step 1
expSoCPHistory{1}(:,:,1) = CP(:,:,1) + ...
    [0.0000000000 0.7388345886 1.6858997350 2.1521052011 2.1521052011 1.6858997350 0.7388345886 0.0000000000
    0.0397729067 0.5056553036 1.2342293403 1.6049804879 1.6049804879 1.2342293403 0.5056553036 0.0397729067
    0.0382660108 0.2613837639 0.6294571576 0.8319686389 0.8319686389 0.6294571576 0.2613837639 0.0382660108
    0.0143747520 0.0791550464 0.1923657909 0.2555235259 0.2555235259 0.1923657909 0.0791550464 0.0143747520
    -0.0143747520 -0.0791550464 -0.1923657909 -0.2555235259 -0.2555235259 -0.1923657909 -0.0791550464 -0.0143747520
    -0.0382660108 -0.2613837639 -0.6294571576 -0.8319686389 -0.8319686389 -0.6294571576 -0.2613837639 -0.0382660108
    -0.0397729067 -0.5056553036 -1.2342293403 -1.6049804879 -1.6049804879 -1.2342293403 -0.5056553036 -0.0397729067
     0.0000000000 -0.7388345886 -1.6858997350 -2.1521052011 -2.1521052011 -1.6858997350 -0.7388345886 0.0000000000];
expSoCPHistory{1}(:,:,2) = CP(:,:,2) + ...
     [0.0000000000 0.0397729067 0.0382660108 0.0143747520 -0.0143747520 -0.0382660108 -0.0397729067 0.0000000000
      0.7388345886 0.5056553036 0.2613837639 0.0791550464 -0.0791550464 -0.2613837639 -0.5056553036 -0.7388345886
      1.6858997350 1.2342293403 0.6294571576 0.1923657909 -0.1923657909 -0.6294571576 -1.2342293403 -1.6858997350
      2.1521052011 1.6049804879 0.8319686389 0.2555235259 -0.2555235259 -0.8319686389 -1.6049804879 -2.1521052011
      2.1521052011 1.6049804879 0.8319686389 0.2555235259 -0.2555235259 -0.8319686389 -1.6049804879 -2.1521052011
      1.6858997350 1.2342293403 0.6294571576 0.1923657909 -0.1923657909 -0.6294571576 -1.2342293403 -1.6858997350
      0.7388345886 0.5056553036 0.2613837639 0.0791550464 -0.0791550464 -0.2613837639 -0.5056553036 -0.7388345886
      0.0000000000 0.0397729067 0.0382660108 0.0143747520 -0.0143747520 -0.0382660108 -0.0397729067 0.0000000000];
expSoCPHistory{1}(:,:,3) = CP(:,:,3) + ...
    [0.0000000000 -0.1301119102 -0.1643433752 -0.0692257564 0.0692257564 0.1643433752 0.1301119102 0.0000000000
     -0.1301119102 -0.1493991805 -0.1467859645 -0.0585362460 0.0585362460 0.1467859645 0.1493991805 0.1301119102
     -0.1643433752 -0.1467859645 -0.1055840689 -0.0395257657 0.0395257657 0.1055840689 0.1467859645 0.1643433752
     -0.0692257564 -0.0585362460 -0.0395257657 -0.0141944187 0.0141944187 0.0395257657 0.0585362460 0.0692257564
     0.0692257564 0.0585362460 0.0395257657 0.0141944187 -0.0141944187 -0.0395257657 -0.0585362460 -0.0692257564
     0.1643433752 0.1467859645 0.1055840689 0.0395257657 -0.0395257657 -0.1055840689 -0.1467859645 -0.1643433752
     0.1301119102 0.1493991805 0.1467859645 0.0585362460 -0.0585362460 -0.1467859645 -0.1493991805 -0.1301119102
     0.0000000000 0.1301119102 0.1643433752 0.0692257564 -0.0692257564 -0.1643433752 -0.1301119102 0.0000000000];
expSoCPHistory{1}(:,:,4) = CP(:,:,4);
% Form-finding step 2
expSoCPHistory{2}(:,:,1) = CP(:,:,1) + ...
    [0.0000000000 0.9741099672 2.1846340589 2.7718167146 2.7718167146 2.1846340589 0.9741099672 0.0000000000
    0.0291218870 0.6648116464 1.6076441629 2.0892143036 2.0892143036 1.6076441629 0.6648116464 0.0291218870
    0.0223356966 0.3209528568 0.8125464181 1.0855563183 1.0855563183 0.8125464181 0.3209528568 0.0223356966
    0.0070121825 0.0919493168 0.2449695173 0.3319281939 0.3319281939 0.2449695173 0.0919493168 0.0070121825
    -0.0070121825 -0.0919493168 -0.2449695172 -0.3319281939 -0.3319281939 -0.2449695172 -0.0919493168 -0.0070121825
    -0.0223356966 -0.3209528568 -0.8125464181 -1.0855563183 -1.0855563183 -0.8125464181 -0.3209528568 -0.0223356966
    -0.0291218870 -0.6648116464 -1.6076441629 -2.0892143036 -2.0892143036 -1.6076441629 -0.6648116464 -0.0291218870
     0.0000000000 -0.9741099672 -2.1846340589 -2.7718167146 -2.7718167146 -2.1846340589 -0.9741099672 0.0000000000];
expSoCPHistory{2}(:,:,2) = CP(:,:,2) + ...
    [0.0000000000 0.0291218870 0.0223356966 0.0070121825 -0.0070121825 -0.0223356966 -0.0291218870 0.0000000000
     0.9741099672 0.6648116464 0.3209528568 0.0919493168 -0.0919493168 -0.3209528568 -0.6648116464 -0.9741099672
     2.1846340589 1.6076441629 0.8125464181 0.2449695173 -0.2449695172 -0.8125464181 -1.6076441629 -2.1846340589
     2.7718167146 2.0892143036 1.0855563183 0.3319281939 -0.3319281939 -1.0855563183 -2.0892143036 -2.7718167146
     2.7718167146 2.0892143036 1.0855563183 0.3319281939 -0.3319281939 -1.0855563183 -2.0892143036 -2.7718167146
     2.1846340589 1.6076441629 0.8125464181 0.2449695173 -0.2449695172 -0.8125464181 -1.6076441629 -2.1846340589
     0.9741099672 0.6648116464 0.3209528568 0.0919493168 -0.0919493168 -0.3209528568 -0.6648116464 -0.9741099672
     0.0000000000 0.0291218870 0.0223356966 0.0070121825 -0.0070121825 -0.0223356966 -0.0291218870 0.0000000000];
expSoCPHistory{2}(:,:,3) = CP(:,:,3) + ...
    [0.0000000000 -0.1807363663 -0.2376651923 -0.1016550820 0.1016550820 0.2376651923 0.1807363663 0.0000000000
    -0.1807363663 -0.2567414797 -0.2805123200 -0.1147137383 0.1147137383 0.2805123200 0.2567414797 0.1807363663
    -0.2376651923 -0.2805123200 -0.2413998384 -0.0934867895 0.0934867895 0.2413998384 0.2805123200 0.2376651923
    -0.1016550820 -0.1147137383 -0.0934867895 -0.0355680745 0.0355680745 0.0934867895 0.1147137383 0.1016550820
     0.1016550820 0.1147137383 0.0934867895 0.0355680745 -0.0355680745 -0.0934867895 -0.1147137383 -0.1016550820
     0.2376651923 0.2805123200 0.2413998384 0.0934867895 -0.0934867895 -0.2413998384 -0.2805123200 -0.2376651923
     0.1807363663 0.2567414797 0.2805123200 0.1147137383 -0.1147137383 -0.2805123200 -0.2567414797 -0.1807363663
     0.0000000000 0.1807363663 0.2376651923 0.1016550820 -0.1016550820 -0.2376651923 -0.1807363663 0.0000000000];
expSoCPHistory{2}(:,:,4) = CP(:,:,4);
% Form-finding step 3
expSoCPHistory{3}(:,:,1) = CP(:,:,1) + ...
    [0.0000000000 1.0882315096 2.4029230459 3.0317483865 3.0317483865 2.4029230459 1.0882315096 0.0000000000
     0.0187800921 0.7436201576 1.7744222319 2.2969376108 2.2969376108 1.7744222319 0.7436201576 0.0187800921
     0.0132100782 0.3524116549 0.8971974262 1.1977039808 1.1977039808 0.8971974262 0.3524116549 0.0132100782
     0.0034618927 0.0991303016 0.2701137159 0.3662164550 0.3662164550 0.2701137159 0.0991303016 0.0034618927
     -0.0034618927 -0.0991303016 -0.2701137159 -0.3662164550 -0.3662164550 -0.2701137159 -0.0991303016 -0.0034618927
     -0.0132100782 -0.3524116549 -0.8971974262 -1.1977039808 -1.1977039808 -0.8971974262 -0.3524116549 -0.0132100782
     -0.0187800921 -0.7436201576 -1.7744222319 -2.2969376108 -2.2969376108 -1.7744222319 -0.7436201576 -0.0187800921
      0.0000000000 -1.0882315096 -2.4029230459 -3.0317483865 -3.0317483865 -2.4029230459 -1.0882315096 0.0000000000];
expSoCPHistory{3}(:,:,2) = CP(:,:,2) + ...
    [0.0000000000 0.0187800921 0.0132100782 0.0034618927 -0.0034618927 -0.0132100782 -0.0187800921 0.0000000000
     1.0882315096 0.7436201576 0.3524116549 0.0991303016 -0.0991303016 -0.3524116549 -0.7436201576 -1.0882315096
     2.4029230459 1.7744222319 0.8971974262 0.2701137159 -0.2701137159 -0.8971974262 -1.7744222319 -2.4029230459
     3.0317483865 2.2969376108 1.1977039808 0.3662164550 -0.3662164550 -1.1977039808 -2.2969376108 -3.0317483865
     3.0317483865 2.2969376108 1.1977039808 0.3662164550 -0.3662164550 -1.1977039808 -2.2969376108 -3.0317483865
     2.4029230459 1.7744222319 0.8971974262 0.2701137159 -0.2701137159 -0.8971974262 -1.7744222319 -2.4029230459
     1.0882315096 0.7436201576 0.3524116549 0.0991303016 -0.0991303016 -0.3524116549 -0.7436201576 -1.0882315096
     0.0000000000 0.0187800921 0.0132100782 0.0034618927 -0.0034618927 -0.0132100782 -0.0187800921 0.0000000000];
expSoCPHistory{3}(:,:,3) = CP(:,:,3) + ...
    [0                   -0.203162942000000  -0.269334684400000  -0.115674261800000   0.115674261800000   0.269334684400000   0.203162942000000                   0
     -0.203162942000000  -0.289692077600000  -0.328800978000000  -0.136512010100000   0.136512010100000   0.328800978000000   0.289692077600000   0.203162942000000
     -0.269334684400000  -0.328800978000000  -0.290761879500000  -0.112330183200000   0.112330183200000   0.290761879500000   0.328800978000000   0.269334684400000
     -0.115674261800000  -0.136512010100000  -0.112330183200000  -0.042865625800000   0.042865625800000   0.112330183200000   0.136512010100000   0.115674261800000
     0.115674261800000   0.136512010100000   0.112330183200000   0.042865625800000  -0.042865625800000  -0.112330183200000  -0.136512010100000  -0.115674261800000
     0.269334684400000   0.328800978000000   0.290761879500000   0.112330183200000  -0.112330183200000  -0.290761879500000  -0.328800978000000  -0.269334684400000
     0.203162942000000   0.289692077600000   0.328800978000000   0.136512010100000  -0.136512010100000  -0.328800978000000  -0.289692077600000  -0.203162942000000
                     0   0.203162942000000   0.269334684400000   0.115674261800000  -0.115674261800000  -0.269334684400000  -0.203162942000000                   0];
expSoCPHistory{3}(:,:,4) = CP(:,:,4);
% Form-finding step 4
expSoCPHistory{4}(:,:,1) = CP(:,:,1) + ...
    [0                   1.149444796900000   2.511754066700000   3.157453155800000   3.157453155800000   2.511754066700000   1.149444796900000                   0
     0.011155194100000   0.784492892500000   1.857792069400000   2.398400960100000   2.398400960100000   1.857792069400000   0.784492892500000   0.011155194100000
     0.008134186100000   0.369151241900000   0.939811049000000   1.253257279200000   1.253257279200000   0.939811049000000   0.369151241900000   0.008134186100000
     0.001704248200000   0.102989273800000   0.282961148700000   0.383293176900000   0.383293176900000   0.282961148700000   0.102989273800000   0.001704248200000
     -0.001704248200000  -0.102989273800000  -0.282961148700000  -0.383293176900000  -0.383293176900000  -0.282961148700000  -0.102989273800000  -0.001704248200000
     -0.008134186100000  -0.369151241900000  -0.939811049000000  -1.253257279200000  -1.253257279200000  -0.939811049000000  -0.369151241900000  -0.008134186100000
     -0.011155194100000  -0.784492892500000  -1.857792069400000  -2.398400960100000  -2.398400960100000  -1.857792069400000  -0.784492892500000  -0.011155194100000
     0                   -1.149444796900000  -2.511754066700000  -3.157453155800000  -3.157453155800000  -2.511754066700000  -1.149444796900000                   0];
expSoCPHistory{4}(:,:,2) = CP(:,:,2) + ...
    [0                   0.011155194100000   0.008134186100000   0.001704248200000  -0.001704248200000  -0.008134186100000  -0.011155194100000                   0
     1.149444796900000   0.784492892500000   0.369151241900000   0.102989273800000  -0.102989273800000  -0.369151241900000  -0.784492892500000  -1.149444796900000
     2.511754066700000   1.857792069400000   0.939811049000000   0.282961148700000  -0.282961148700000  -0.939811049000000  -1.857792069400000  -2.511754066700000
     3.157453155800000   2.398400960100000   1.253257279200000   0.383293176900000  -0.383293176900000  -1.253257279200000  -2.398400960100000  -3.157453155800000
     3.157453155800000   2.398400960100000   1.253257279200000   0.383293176900000  -0.383293176900000  -1.253257279200000  -2.398400960100000  -3.157453155800000
     2.511754066700000   1.857792069400000   0.939811049000000   0.282961148700000  -0.282961148700000  -0.939811049000000  -1.857792069400000  -2.511754066700000
     1.149444796900000   0.784492892500000   0.369151241900000   0.102989273800000  -0.102989273800000  -0.369151241900000  -0.784492892500000  -1.149444796900000
                     0   0.011155194100000   0.008134186100000   0.001704248200000  -0.001704248200000  -0.008134186100000  -0.011155194100000                   0];
expSoCPHistory{4}(:,:,3) = CP(:,:,3) + ...
    [                 0  -0.214784271300000  -0.285085854600000  -0.122501565400000   0.122501565400000   0.285085854600000   0.214784271300000                   0
     -0.214784271300000  -0.305131323800000  -0.350615551100000  -0.146570800800000   0.146570800800000   0.350615551100000   0.305131323800000   0.214784271300000
     -0.285085854600000  -0.350615551100000  -0.312933126600000  -0.120616206000000   0.120616206000000   0.312933126600000   0.350615551100000   0.285085854600000
     -0.122501565400000  -0.146570800800000  -0.120616206000000  -0.046041727300000   0.046041727300000   0.120616206000000   0.146570800800000   0.122501565400000
     0.122501565400000   0.146570800800000   0.120616206000000   0.046041727300000  -0.046041727300000  -0.120616206000000  -0.146570800800000  -0.122501565400000
     0.285085854600000   0.350615551100000   0.312933126600000   0.120616206000000  -0.120616206000000  -0.312933126600000  -0.350615551100000  -0.285085854600000
     0.214784271300000   0.305131323800000   0.350615551100000   0.146570800800000  -0.146570800800000  -0.350615551100000  -0.305131323800000  -0.214784271300000
                      0   0.214784271300000   0.285085854600000   0.122501565400000  -0.122501565400000  -0.285085854600000  -0.214784271300000                   0];
expSoCPHistory{4}(:,:,4) = CP(:,:,4);
% Form-finding step 5
expSoCPHistory{5}(:,:,1) = CP(:,:,1) + ...
    [                0   1.183850702100000   2.569940177600000   3.223397405500000   3.223397405500000   2.569940177600000   1.183850702100000                   0
     0.005949677600000   0.806784349100000   1.902317699900000   2.451902488500000   2.451902488500000   1.902317699900000   0.806784349100000   0.005949677600000
     0.005297310800000   0.378409606400000   0.962531728600000   1.282787858700000   1.282787858700000   0.962531728600000   0.378409606400000   0.005297310800000
     0.000758232400000   0.105086866300000   0.289895307000000   0.392386134900000   0.392386134900000   0.289895307000000   0.105086866300000   0.000758232400000
     -0.000758232400000  -0.105086866300000  -0.289895307000000  -0.392386134900000  -0.392386134900000  -0.289895307000000  -0.105086866300000  -0.000758232400000
     -0.005297310700000  -0.378409606400000  -0.962531728600000  -1.282787858700000  -1.282787858700000  -0.962531728600000  -0.378409606400000  -0.005297310700000
     -0.005949677600000  -0.806784349100000  -1.902317699900000  -2.451902488500000  -2.451902488500000  -1.902317699900000  -0.806784349100000  -0.005949677600000
                     0  -1.183850702100000  -2.569940177600000  -3.223397405500000  -3.223397405500000  -2.569940177600000  -1.183850702100000                   0];
expSoCPHistory{5}(:,:,2) = CP(:,:,2) + ...
    [                0   0.005949677600000   0.005297310800000   0.000758232400000  -0.000758232400000  -0.005297310700000  -0.005949677600000                   0
     1.183850702100000   0.806784349100000   0.378409606400000   0.105086866300000  -0.105086866300000  -0.378409606400000  -0.806784349100000  -1.183850702100000
     2.569940177600000   1.902317699900000   0.962531728600000   0.289895307000000  -0.289895307000000  -0.962531728600000  -1.902317699900000  -2.569940177600000
     3.223397405500000   2.451902488500000   1.282787858700000   0.392386134900000  -0.392386134900000  -1.282787858700000  -2.451902488500000  -3.223397405500000
     3.223397405500000   2.451902488500000   1.282787858700000   0.392386134900000  -0.392386134900000  -1.282787858700000  -2.451902488500000  -3.223397405500000
     2.569940177600000   1.902317699900000   0.962531728600000   0.289895307000000  -0.289895307000000  -0.962531728600000  -1.902317699900000  -2.569940177600000
     1.183850702100000   0.806784349100000   0.378409606400000   0.105086866300000  -0.105086866300000  -0.378409606400000  -0.806784349100000  -1.183850702100000
                     0   0.005949677600000   0.005297310800000   0.000758232400000  -0.000758232400000  -0.005297310700000  -0.005949677600000                   0];
expSoCPHistory{5}(:,:,3) = CP(:,:,3) + ...
    [                 0  -0.221153755000000  -0.293527490700000  -0.126084190900000   0.126084190900000   0.293527490700000   0.221153755000000                   0
     -0.221153755000000  -0.313341557700000  -0.361704954700000  -0.151672829700000   0.151672829700000   0.361704954700000   0.313341557700000   0.221153755000000
     -0.293527490700000  -0.361704954700000  -0.324012071700000  -0.124742917700000   0.124742917700000   0.324012071700000   0.361704954700000   0.293527490700000
     -0.126084190900000  -0.151672829700000  -0.124742917700000  -0.047606697100000   0.047606697100000   0.124742917700000   0.151672829700000   0.126084190900000
     0.126084190900000   0.151672829700000   0.124742917700000   0.047606697100000  -0.047606697100000  -0.124742917700000  -0.151672829700000  -0.126084190900000
     0.293527490700000   0.361704954700000   0.324012071700000   0.124742917700000  -0.124742917700000  -0.324012071700000  -0.361704954700000  -0.293527490700000
     0.221153755000000   0.313341557700000   0.361704954700000   0.151672829700000  -0.151672829700000  -0.361704954700000  -0.313341557700000  -0.221153755000000
                     0   0.221153755000000   0.293527490700000   0.126084190900000  -0.126084190900000  -0.293527490700000  -0.221153755000000                   0];
expSoCPHistory{5}(:,:,4) = CP(:,:,4);
% Form-finding step 6
expSoCPHistory{6}(:,:,1) = CP(:,:,1) + ...
    [                0   1.203640189100000   2.602382520200000   3.259731460200000   3.259731460200000   2.602382520200000   1.203640189100000                   0
     0.002465859800000   0.819344451000000   1.927101055900000   2.481462459500000   2.481462459500000   1.927101055900000   0.819344451000000   0.002465859800000
     0.003707504900000   0.383707707400000   0.975068708300000   1.299201644400000   1.299201644400000   0.975068708300000   0.383707707400000   0.003707504900000
     0.000210637000000   0.106232965000000   0.293781981000000   0.397436418900000   0.397436418900000   0.293781981000000   0.106232965000000   0.000210637000000
     -0.000210637000000  -0.106232965000000  -0.293781981000000  -0.397436418900000  -0.397436418900000  -0.293781981000000  -0.106232965000000  -0.000210637000000
     -0.003707504900000  -0.383707707400000  -0.975068708300000  -1.299201644400000  -1.299201644400000  -0.975068708300000  -0.383707707400000  -0.003707504900000
     -0.002465859800000  -0.819344451000000  -1.927101055900000  -2.481462459500000  -2.481462459500000  -1.927101055900000  -0.819344451000000  -0.002465859800000
                     0  -1.203640189100000  -2.602382520200000  -3.259731460100000  -3.259731460100000  -2.602382520200000  -1.203640189100000                   0];
expSoCPHistory{6}(:,:,2) = CP(:,:,2) + ...
    [                0   0.002465859800000   0.003707504900000   0.000210637000000  -0.000210637000000  -0.003707504900000  -0.002465859800000                   0
     1.203640189100000   0.819344451000000   0.383707707400000   0.106232965000000  -0.106232965000000  -0.383707707400000  -0.819344451000000  -1.203640189100000
     2.602382520200000   1.927101055900000   0.975068708300000   0.293781981000000  -0.293781981000000  -0.975068708300000  -1.927101055900000  -2.602382520200000
     3.259731460200000   2.481462459500000   1.299201644400000   0.397436418900000  -0.397436418900000  -1.299201644400000  -2.481462459500000  -3.259731460100000
     3.259731460200000   2.481462459500000   1.299201644400000   0.397436418900000  -0.397436418900000  -1.299201644400000  -2.481462459500000  -3.259731460100000
     2.602382520200000   1.927101055900000   0.975068708300000   0.293781981000000  -0.293781981000000  -0.975068708300000  -1.927101055900000  -2.602382520200000
     1.203640189100000   0.819344451000000   0.383707707400000   0.106232965000000  -0.106232965000000  -0.383707707400000  -0.819344451000000  -1.203640189100000
                     0   0.002465859800000   0.003707504900000   0.000210637000000  -0.000210637000000  -0.003707504900000  -0.002465859800000                   0];
expSoCPHistory{6}(:,:,3) = CP(:,:,3) + ...
    [                  0  -0.224704101100000  -0.298258109700000  -0.128049545400000   0.128049545400000   0.298258109700000   0.224704101100000                   0
      -0.224704101100000  -0.317933057800000  -0.367730804400000  -0.154411066700000   0.154411066700000   0.367730804400000   0.317933057800000   0.224704101100000
      -0.298258109700000  -0.367730804400000  -0.329888001600000  -0.126957080300000   0.126957080300000   0.329888001600000   0.367730804400000   0.298258109700000
      -0.128049545400000  -0.154411066700000  -0.126957080300000  -0.048435316300000   0.048435316300000   0.126957080300000   0.154411066700000   0.128049545400000
       0.128049545400000   0.154411066700000   0.126957080300000   0.048435316300000  -0.048435316300000  -0.126957080300000  -0.154411066700000  -0.128049545400000
       0.298258109700000   0.367730804400000   0.329888001600000   0.126957080300000  -0.126957080300000  -0.329888001600000  -0.367730804400000  -0.298258109700000
       0.224704101100000   0.317933057800000   0.367730804400000   0.154411066700000  -0.154411066700000  -0.367730804400000  -0.317933057800000  -0.224704101100000
                       0   0.224704101100000   0.298258109700000   0.128049545400000  -0.128049545400000  -0.298258109700000  -0.224704101100000                   0];
expSoCPHistory{6}(:,:,4) = CP(:,:,4);
% Form-finding step 7
expSoCPHistory{7}(:,:,1) = CP(:,:,1) + ...
    [                  0   1.215135454100000   2.620955417700000   3.280365851600000   3.280365851600000   2.620955417700000   1.215135454100000                   0
       0.000116975400000   0.826561349300000   1.941264344900000   2.498273214700000   2.498273214700000   1.941264344900000   0.826561349300000   0.000116975400000
       0.002823569200000   0.386826881700000   0.982105054400000   1.308592641800000   1.308592641800000   0.982105054400000   0.386826881700000   0.002823569200000
      -0.000126513500000   0.106851108500000   0.296017332900000   0.400316697200000   0.400316697200000   0.296017332900000   0.106851108500000  -0.000126513500000
       0.000126513500000  -0.106851108500000  -0.296017332900000  -0.400316697200000  -0.400316697200000  -0.296017332900000  -0.106851108500000   0.000126513500000
      -0.002823569200000  -0.386826881700000  -0.982105054400000  -1.308592641800000  -1.308592641800000  -0.982105054400000  -0.386826881700000  -0.002823569200000
      -0.000116975400000  -0.826561349300000  -1.941264344900000  -2.498273214700000  -2.498273214700000  -1.941264344900000  -0.826561349300000  -0.000116975400000
                       0  -1.215135454000000  -2.620955417700000  -3.280365851600000  -3.280365851600000  -2.620955417700000  -1.215135454000000                   0];
expSoCPHistory{7}(:,:,2) = CP(:,:,2) + ...
    [                  0   0.000116975400000   0.002823569200000  -0.000126513500000   0.000126513500000  -0.002823569200000  -0.000116975400000                   0
       1.215135454100000   0.826561349300000   0.386826881700000   0.106851108500000  -0.106851108500000  -0.386826881700000  -0.826561349300000  -1.215135454000000
       2.620955417700000   1.941264344900000   0.982105054400000   0.296017332900000  -0.296017332900000  -0.982105054400000  -1.941264344900000  -2.620955417700000
       3.280365851600000   2.498273214700000   1.308592641800000   0.400316697200000  -0.400316697200000  -1.308592641800000  -2.498273214700000  -3.280365851600000
       3.280365851600000   2.498273214700000   1.308592641800000   0.400316697200000  -0.400316697200000  -1.308592641800000  -2.498273214700000  -3.280365851600000
       2.620955417700000   1.941264344900000   0.982105054400000   0.296017332900000  -0.296017332900000  -0.982105054400000  -1.941264344900000  -2.620955417700000
       1.215135454100000   0.826561349300000   0.386826881700000   0.106851108500000  -0.106851108500000  -0.386826881700000  -0.826561349300000  -1.215135454000000
                       0   0.000116975400000   0.002823569200000  -0.000126513500000   0.000126513500000  -0.002823569200000  -0.000116975400000                   0];
expSoCPHistory{7}(:,:,3) = CP(:,:,3) + ...
    [                  0  -0.226665783200000  -0.300988663100000  -0.129154650200000   0.129154650200000   0.300988663100000   0.226665783200000                   0
      -0.226665783200000  -0.320560680800000  -0.371141847500000  -0.155929124100000   0.155929124100000   0.371141847500000   0.320560680800000   0.226665783200000
      -0.300988663100000  -0.371141847500000  -0.333101703200000  -0.128203569100000   0.128203569100000   0.333101703200000   0.371141847500000   0.300988663100000
      -0.129154650200000  -0.155929124100000  -0.128203569100000  -0.048893059200000   0.048893059200000   0.128203569100000   0.155929124100000   0.129154650200000
       0.129154650200000   0.155929124100000   0.128203569100000   0.048893059200000  -0.048893059200000  -0.128203569100000  -0.155929124100000  -0.129154650200000
       0.300988663100000   0.371141847500000   0.333101703200000   0.128203569100000  -0.128203569100000  -0.333101703200000  -0.371141847500000  -0.300988663100000
       0.226665783200000   0.320560680800000   0.371141847500000   0.155929124100000  -0.155929124100000  -0.371141847500000  -0.320560680800000  -0.226665783200000
                       0   0.226665783200000   0.300988663100000   0.129154650200000  -0.129154650200000  -0.300988663100000  -0.226665783200000                   0];
expSoCPHistory{7}(:,:,4) = CP(:,:,4);
% Form-finding step 8
expSoCPHistory{8}(:,:,1) = CP(:,:,1) + ...
    [                  0   1.221819007500000   2.631771169400000   3.292305966300000   3.292305966300000   2.631771169400000   1.221819007500000                   0
      -0.001510709100000   0.830752178900000   1.949496753500000   2.508005129700000   2.508005129700000   1.949496753500000   0.830752178900000  -0.001510709100000
       0.002345029300000   0.388712540500000   0.986062068600000   1.314071996400000   1.314071996400000   0.986062068600000   0.388712540500000   0.002345029300000
      -0.000346217500000   0.107169867600000   0.297326666800000   0.401986525200000   0.401986525200000   0.297326666800000   0.107169867600000  -0.000346217500000
       0.000346217500000  -0.107169867600000  -0.297326666800000  -0.401986525200000  -0.401986525200000  -0.297326666800000  -0.107169867600000   0.000346217500000
      -0.002345029300000  -0.388712540500000  -0.986062068600000  -1.314071996400000  -1.314071996400000  -0.986062068600000  -0.388712540500000  -0.002345029300000
       0.001510709100000  -0.830752178900000  -1.949496753500000  -2.508005129700000  -2.508005129700000  -1.949496753500000  -0.830752178900000   0.001510709100000
                       0  -1.221819007500000  -2.631771169400000  -3.292305966300000  -3.292305966300000  -2.631771169400000  -1.221819007500000                   0];
expSoCPHistory{8}(:,:,2) = CP(:,:,2) + ...
    [                  0  -0.001510709100000   0.002345029300000  -0.000346217500000   0.000346217500000  -0.002345029300000   0.001510709100000                   0
       1.221819007500000   0.830752178900000   0.388712540500000   0.107169867600000  -0.107169867600000  -0.388712540500000  -0.830752178900000  -1.221819007500000
       2.631771169400000   1.949496753500000   0.986062068600000   0.297326666800000  -0.297326666800000  -0.986062068600000  -1.949496753500000  -2.631771169400000
       3.292305966300000   2.508005129700000   1.314071996400000   0.401986525200000  -0.401986525200000  -1.314071996400000  -2.508005129700000  -3.292305966300000
       3.292305966300000   2.508005129700000   1.314071996400000   0.401986525200000  -0.401986525200000  -1.314071996400000  -2.508005129700000  -3.292305966300000
       2.631771169400000   1.949496753500000   0.986062068600000   0.297326666800000  -0.297326666800000  -0.986062068600000  -1.949496753500000  -2.631771169400000
       1.221819007500000   0.830752178900000   0.388712540500000   0.107169867600000  -0.107169867600000  -0.388712540500000  -0.830752178900000  -1.221819007500000
                       0  -0.001510709100000   0.002345029300000  -0.000346217500000   0.000346217500000  -0.002345029300000   0.001510709100000                   0];
expSoCPHistory{8}(:,:,3) = CP(:,:,3) + ...
    [                  0  -0.227709452600000  -0.302599614400000  -0.129782768600000   0.129782768700000   0.302599614400000   0.227709452600000                   0
      -0.227709452600000  -0.322078312500000  -0.373126535000000  -0.156783813300000   0.156783813300000   0.373126535000000   0.322078312500000   0.227709452600000
      -0.302599614400000  -0.373126535000000  -0.334875079900000  -0.128929791100000   0.128929791100000   0.334875079900000   0.373126535000000   0.302599614400000
      -0.129782768600000  -0.156783813300000  -0.128929791100000  -0.049152047400000   0.049152047400000   0.128929791100000   0.156783813300000   0.129782768700000
       0.129782768700000   0.156783813300000   0.128929791100000   0.049152047400000  -0.049152047400000  -0.128929791100000  -0.156783813300000  -0.129782768600000
       0.302599614400000   0.373126535000000   0.334875079900000   0.128929791100000  -0.128929791100000  -0.334875079900000  -0.373126535000000  -0.302599614400000
       0.227709452600000   0.322078312500000   0.373126535000000   0.156783813300000  -0.156783813300000  -0.373126535000000  -0.322078312500000  -0.227709452600000
                       0   0.227709452600000   0.302599614400000   0.129782768700000  -0.129782768600000  -0.302599614400000  -0.227709452600000                   0];
expSoCPHistory{8}(:,:,4) = CP(:,:,4);
% Form-finding step 9
expSoCPHistory{9}(:,:,1) = CP(:,:,1) + ...
    [                  0   1.225677043500000   2.638142084500000   3.299295083400000   3.299295083400000   2.638142084500000   1.225677043500000                   0
      -0.002689374500000   0.833194930200000   1.954334713800000   2.513699510500000   2.513699510500000   1.954334713800000   0.833194930200000  -0.002689374500000
       0.002101485900000   0.389885960600000   0.988254448200000   1.317315950300000   1.317315950300000   0.988254448200000   0.389885960600000   0.002101485900000
      -0.000497624300000   0.107316301700000   0.298104745000000   0.402964039100000   0.402964039100000   0.298104745000000   0.107316301700000  -0.000497624300000
       0.000497624300000  -0.107316301700000  -0.298104745000000  -0.402964039000000  -0.402964039000000  -0.298104745000000  -0.107316301700000   0.000497624300000
      -0.002101485900000  -0.389885960600000  -0.988254448200000  -1.317315950300000  -1.317315950300000  -0.988254448200000  -0.389885960600000  -0.002101485900000
       0.002689374500000  -0.833194930200000  -1.954334713800000  -2.513699510500000  -2.513699510500000  -1.954334713800000  -0.833194930200000   0.002689374500000
                       0  -1.225677043500000  -2.638142084500000  -3.299295083300000  -3.299295083300000  -2.638142084500000  -1.225677043500000                   0];
expSoCPHistory{9}(:,:,2) = CP(:,:,2) + ...
    [                  0  -0.002689374500000   0.002101485900000  -0.000497624300000   0.000497624300000  -0.002101485900000   0.002689374500000                   0
       1.225677043500000   0.833194930200000   0.389885960600000   0.107316301700000  -0.107316301700000  -0.389885960600000  -0.833194930200000  -1.225677043500000
       2.638142084500000   1.954334713800000   0.988254448200000   0.298104745000000  -0.298104745000000  -0.988254448200000  -1.954334713800000  -2.638142084500000
       3.299295083400000   2.513699510500000   1.317315950300000   0.402964039100000  -0.402964039000000  -1.317315950300000  -2.513699510500000  -3.299295083300000
       3.299295083400000   2.513699510500000   1.317315950300000   0.402964039100000  -0.402964039000000  -1.317315950300000  -2.513699510500000  -3.299295083300000
       2.638142084500000   1.954334713800000   0.988254448200000   0.298104745000000  -0.298104745000000  -0.988254448200000  -1.954334713800000  -2.638142084500000
       1.225677043500000   0.833194930200000   0.389885960600000   0.107316301700000  -0.107316301700000  -0.389885960600000  -0.833194930200000  -1.225677043500000
                       0  -0.002689374500000   0.002101485900000  -0.000497624300000   0.000497624300000  -0.002101485900000   0.002689374500000                   0];
expSoCPHistory{9}(:,:,3) = CP(:,:,3) + ...
    [                  0  -0.228215739400000  -0.303568175600000  -0.130139468900000   0.130139468900000   0.303568175600000   0.228215739400000                   0
      -0.228215739400000  -0.322954299600000  -0.374305976000000  -0.157265524300000   0.157265524300000   0.374305976000000   0.322954299600000   0.228215739400000
      -0.303568175600000  -0.374305976000000  -0.335840713600000  -0.129365195500000   0.129365195500000   0.335840713600000   0.374305976000000   0.303568175600000
      -0.130139468900000  -0.157265524300000  -0.129365195500000  -0.049300196700000   0.049300196700000   0.129365195500000   0.157265524300000   0.130139468900000
       0.130139468900000   0.157265524300000   0.129365195500000   0.049300196700000  -0.049300196700000  -0.129365195500000  -0.157265524300000  -0.130139468900000
       0.303568175600000   0.374305976000000   0.335840713600000   0.129365195500000  -0.129365195500000  -0.335840713600000  -0.374305976000000  -0.303568175600000
       0.228215739400000   0.322954299600000   0.374305976000000   0.157265524300000  -0.157265524300000  -0.374305976000000  -0.322954299600000  -0.228215739400000
                       0   0.228215739400000   0.303568175600000   0.130139468900000  -0.130139468900000  -0.303568175600000  -0.228215739400000                   0];
expSoCPHistory{9}(:,:,4) = CP(:,:,4);
% Form-finding step 10
expSoCPHistory{10}(:,:,1) = CP(:,:,1) + ...
    [                  0   1.227864940200000   2.641926299400000   3.303414425800000   3.303414425800000   2.641926299400000   1.227864940200000                   0
      -0.003591635300000   0.834615182900000   1.957198834800000   2.517051296400000   2.517051296400000   1.957198834800000   0.834615182900000  -0.003591635300000
       0.001994598500000   0.390642541700000   0.989420394100000   1.319261225300000   1.319261225300000   0.989420394100000   0.390642541700000   0.001994598500000
      -0.000607944100000   0.107362693400000   0.298573501100000   0.403539175500000   0.403539175500000   0.298573501100000   0.107362693400000  -0.000607944100000
       0.000607944100000  -0.107362693400000  -0.298573501100000  -0.403539175500000  -0.403539175500000  -0.298573501100000  -0.107362693400000   0.000607944100000
      -0.001994598500000  -0.390642541700000  -0.989420394100000  -1.319261225300000  -1.319261225300000  -0.989420394100000  -0.390642541700000  -0.001994598500000
       0.003591635300000  -0.834615182900000  -1.957198834800000  -2.517051296400000  -2.517051296400000  -1.957198834800000  -0.834615182900000   0.003591635300000
                       0  -1.227864940200000  -2.641926299400000  -3.303414425800000  -3.303414425800000  -2.641926299400000  -1.227864940200000                   0];
expSoCPHistory{10}(:,:,2) = CP(:,:,2) + ...
    [                  0  -0.003591635300000   0.001994598500000  -0.000607944100000   0.000607944100000  -0.001994598500000   0.003591635300000                   0
       1.227864940200000   0.834615182900000   0.390642541700000   0.107362693400000  -0.107362693400000  -0.390642541700000  -0.834615182900000  -1.227864940200000
       2.641926299400000   1.957198834800000   0.989420394100000   0.298573501100000  -0.298573501100000  -0.989420394100000  -1.957198834800000  -2.641926299400000
       3.303414425800000   2.517051296400000   1.319261225300000   0.403539175500000  -0.403539175500000  -1.319261225300000  -2.517051296400000  -3.303414425800000
       3.303414425800000   2.517051296400000   1.319261225300000   0.403539175500000  -0.403539175500000  -1.319261225300000  -2.517051296400000  -3.303414425800000
       2.641926299400000   1.957198834800000   0.989420394100000   0.298573501100000  -0.298573501100000  -0.989420394100000  -1.957198834800000  -2.641926299400000
       1.227864940200000   0.834615182900000   0.390642541700000   0.107362693400000  -0.107362693400000  -0.390642541700000  -0.834615182900000  -1.227864940200000
                       0  -0.003591635300000   0.001994598500000  -0.000607944100000   0.000607944100000  -0.001994598500000   0.003591635300000                   0];
expSoCPHistory{10}(:,:,3) = CP(:,:,3) + ...
    [                  0  -0.228405510500000  -0.304162095300000  -0.130339337500000   0.130339337500000   0.304162095300000   0.228405510500000                   0
      -0.228405510500000  -0.323454514400000  -0.375020825400000  -0.157532996300000   0.157532996300000   0.375020825400000   0.323454514400000   0.228405510500000
      -0.304162095300000  -0.375020825400000  -0.336342874100000  -0.129633939900000   0.129633939900000   0.336342874100000   0.375020825400000   0.304162095300000
      -0.130339337500000  -0.157532996300000  -0.129633939900000  -0.049384944500000   0.049384944500000   0.129633939900000   0.157532996300000   0.130339337500000
       0.130339337500000   0.157532996300000   0.129633939900000   0.049384944500000  -0.049384944500000  -0.129633939900000  -0.157532996300000  -0.130339337500000
       0.304162095300000   0.375020825400000   0.336342874100000   0.129633939900000  -0.129633939900000  -0.336342874100000  -0.375020825400000  -0.304162095300000
       0.228405510500000   0.323454514400000   0.375020825400000   0.157532996300000  -0.157532996300000  -0.375020825400000  -0.323454514400000  -0.228405510500000
                       0   0.228405510500000   0.304162095300000   0.130339337500000  -0.130339337500000  -0.304162095300000  -0.228405510500000                   0];
expSoCPHistory{10}(:,:,4) = CP(:,:,4);

% Define the expected solution in terms of the residual history of the
% form-finding iterations
expSolResHistory = [  10.482475864201307
                   7.366127956964769
                   1.790362591771429
                   0.693167398551133
                   0.317350712017801
                   0.160325405712074
                   0.086137104233079
                   0.048126183198140
                   0.027566450900900
                   0.016039501307332];
               
% Define the expected solution in terms of the number of form-finding
% iterations
expSolNoIter = 10;

%% 12. Solve the form-finding analysis problem
[~,CPHistory,resHistory,~,noIter] = ...
    solve_formFindingIGAMembrane ...
    (BSplinePatch, propFormFinding, solve_LinearSystem, '');

%% 13. Verify the solution
testCase.verifyEqual(CPHistory, expSoCPHistory, 'AbsTol', absTolCarat);
testCase.verifyEqual(resHistory, expSolResHistory, 'AbsTol', absTol);
testCase.verifyEqual(noIter, expSolNoIter, 'AbsTol', absTol);

end
